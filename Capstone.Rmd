---
title: "Cyclistic Capstone"
author: "Jessica"
date: "2/25/2022"
output:
  html_document: default
  pdf_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

### Note
This is a case study based on a fictional company for the Google Data Analytics certificate capstone called Cyclistic.  This information is from Divvy Bikes which based in Chicago. Also while doing working this information, I used the Divvy site for locating stations and Google Maps for using coordinates. 

## Stakeholders
* Lily Moreno, Director of Marketing
* Cyclistic Marketing Analytics team
* Cyclistic Executive team


## About Cyclistic
Cyclistic launched a successful bike-share offering in 2016.  Since then, the program has grown to a fleet of 5824 bicycles that are geotracked and locked into a network of 692 stations across Chicago.  The bikes can be unlocked from one station and returned to any other station in the system anytime.

Until now, Cyclistic's marketing strategy relied on building general awareness and appealing to broad consumer segments.  One approach that helped make these things possible was the flexibility of
its pricing plans: single-ride passes, full-day passes, and annual memberships.  Customers who purchase single-ride or full-day passes are referred to as casual riders.  Customer who purchase annual memberships are Cyclistic members.
There are three bike types: electric bikes, docked bikes, and classic bikes.  

Electric bikes are the newest bikes.  They do have a battery that helps with pedaling and give you more control.  E-bikes can be docked at official Cyclistic e-bike docks or locked at any location.

Docked bikes are the second generation bikes.  They work just like ebikes.  They can be docked or locked in private locations.

The classic bike is the first generation and they are the not electric.  Classic bikes can only be docked at bike racks for classic bikes.

Cyclistic's finance analysts have concluded that annual members are much more profitable than casual riders.  Although the the pricing flexibility helps Cyclistic attract more customers, Moreno believes that maximizing the number of annual members will be key to future growth.  rather than creating a marketing campaign that targets all-new customers, Moreno there is a very good chance to convert casual riders into members.  She notes that casual riders are already aware of the Cyclistic program and have chosen Cyclistic for their mobility needs.

## Business Task
The purpose of this project is to understand how Cyclistic's annual members and casual riders use the service.

This information may be used to  determine why casual riders buy Cyclistic annual memberships and to drive them to purchase annual memberships.  The project will identify how long are bikes used for.  Other trends would include if the bikes were used in one way trips or a round trip and which bike does each member typically use.

## Scope of Work
A scope of work was created to help plan.  That can be found [here](https://docs.google.com/document/d/1gXx_AMnOsY-Ozoi3eEhaiCw5LrE6asrLq46AfeJUO1A/edit?usp=sharing&resourcekey=0-PHR4daSvHnnIVllFhFibNg)

## Description of Data Sources used
All the data was provided by Cyclistic.  This is public data that is provided by Cyclistic under this Data License Agreement [linked here] (https://ride.divvybikes.com/data-license-agreement). As you can see this information is not comprehensive or complete, but for this case study the data will help with the business statement. This case study will only use the data between Jan 2021 to Jan 2022.  The data will be used only for this case study and then deleted.  The original data will not be changed or altered in any way.  The data taken will be a copy.

#### Install needed packages

```{r library}
library(tidyverse) #for datasets
library("lubridate") #need this for dates
library(dplyr) #for data manipulation
library(ggplot2) #for elegant data viz presentation
```

#### Import datasets

```{r data}
`202101.divvy.tripdata` <- read.csv("~/Cyclistic_Case_Study/Cyclistic_Capstone/Used/01_2021divvy-tripdata/202101-divvy-tripdata.csv")
`202102.divvy.tripdata` <- read.csv("~/Cyclistic_Case_Study/Cyclistic_Capstone/Used/02_2021divvy-tripdata/202102-divvy-tripdata.csv")
`202103.divvy.tripdata` <- read.csv("~/Cyclistic_Case_Study/Cyclistic_Capstone/Used/03_2021divvy-tripdata/202103-divvy-tripdata.csv")
`202104.divvy.tripdata` <- read.csv("~/Cyclistic_Case_Study/Cyclistic_Capstone/Used/04_2021divvy-tripdata/202104-divvy-tripdata.csv")
`202105.divvy.tripdata` <- read.csv("~/Cyclistic_Case_Study/Cyclistic_Capstone/Used/05_2021divvy-tripdata/202105-divvy-tripdata.csv")
`202106.divvy.tripdata` <- read.csv("~/Cyclistic_Case_Study/Cyclistic_Capstone/Used/06_2021divvy-tripdata/202106-divvy-tripdata.csv")
`202107.divvy.tripdata` <- read.csv("~/Cyclistic_Case_Study/Cyclistic_Capstone/Used/07_2021divvy-tripdata/202107-divvy-tripdata.csv")
`202108.divvy.tripdata` <- read.csv("~/Cyclistic_Case_Study/Cyclistic_Capstone/Used/08_2021divvy-tripdata/202108-divvy-tripdata.csv")
`202109.divvy.tripdata` <- read.csv("~/Cyclistic_Case_Study/Cyclistic_Capstone/Used/09_2021divvy-tripdata/202109-divvy-tripdata.csv")
`202110.divvy.tripdata` <- read.csv("~/Cyclistic_Case_Study/Cyclistic_Capstone/Used/10_2021divvy-tripdata/202110-divvy-tripdata.csv")
`202111.divvy.tripdata` <- read.csv("~/Cyclistic_Case_Study/Cyclistic_Capstone/Used/11_2021divvy-tripdata/202111-divvy-tripdata.csv")
`202112.divvy.tripdata` <- read.csv("~/Cyclistic_Case_Study/Cyclistic_Capstone/Used/12_2021divvy-tripdata/202112-divvy-tripdata.csv")
```

#### A look

```{r datasets}
str(`202101.divvy.tripdata`)
str(`202102.divvy.tripdata`)
str(`202103.divvy.tripdata`)
str(`202104.divvy.tripdata`)
str(`202105.divvy.tripdata`)
str(`202106.divvy.tripdata`)
str(`202107.divvy.tripdata`)
str(`202108.divvy.tripdata`)
str(`202109.divvy.tripdata`)
str(`202110.divvy.tripdata`)
str(`202111.divvy.tripdata`)
str(`202112.divvy.tripdata`)
```

####Combine into one 

```{r combine all tables}
# Combines all datasets into on dataframe
bikes_2021 <- bind_rows(
  `202101.divvy.tripdata`,
  `202102.divvy.tripdata`,
  `202103.divvy.tripdata`,
  `202104.divvy.tripdata`,
  `202105.divvy.tripdata`,
  `202106.divvy.tripdata`,
  `202107.divvy.tripdata`,
  `202108.divvy.tripdata`,
  `202109.divvy.tripdata`,
  `202110.divvy.tripdata`,
  `202111.divvy.tripdata`,
  `202112.divvy.tripdata`,
)
summary(bikes_2021)
str(bikes_2021)
```

I started by look at the first month on excel to familarize myself with the data.  I know that the NA have no recorded data.
Going off the summary from the previous we have NA's in the End latitude and longitude columns to get rid of.  These look like bikes that were stolen or lost. We will also check for duplicates and remove those if any.

```{r deleting entries and duplicates}
## Deletes rows with NA in the end_lat column 
bikes_2021_v2 <- bikes_2021[!is.na(bikes_2021$end_lat),]  
summary(bikes_2021_v2)
# pulls the duplicates by ride_id
bikes_2021$ride_id[duplicated(bikes_2021$ride_id)]
```

There are no duplicates. The entries with NA's in end_lat and end_long are gone.  We have to find the bikes rides that correspond to repairs and quality checks.  They are supposed to be under HQ QR.

``` {r Looking for HQ QR} 
# pulls up all starting stations
bikes_2021_v2 %>% 
  count(start_station_name) 
# previous was very long so increasing how much it will print
options(max.print = 10000000) 
# pulls up all starting stations
bikes_2021_v2 %>% 
  count(start_station_name)
```

So we have nothing called HQ QR.  We do have Base - 2132 W Hubbard Warehouse, Throop/Hastings Mobile Station, DIVVY CASSETTE REPAIR MOBILE STATION, Throop/Hastings Mobile Station, and Base - 2132 W Hubbard Warehouse.  Those might be testing/repair sites.  We have to check for this.  We also have something called the Lyft Driver Center Private Rack. Also note that we have 770902 stations with no names.  
Some have (NU) after a location, for example like "Sheridan Rd & Noyes St (NU)", but that might have to do with Northwestern university. A Google maps look confirms it.  Then we have those that have (temp) after it like "Pulaski Rd & Eddy St (Temp)".  Temp must stand for temporary so those stay, too. There is a duplicate of "Halstead St & 18th St", but one has the (temp) after it.  We have to check that one.  

```{R end station names}
# a list of the ending stations
bikes_2021_v2 %>% 
  count(end_station_name)
```

So again we have 820069 stations rides with blanks.  More than the start station list.  The same locations noted earlier are here too.  

```{r Station ids}
#for the start station ids
bikes_2021_v2 %>% 
  count(start_station_id) 
# for the end station ids
bikes_2021_v2 %>% 
  count(end_station_id) 
```

These are easy to peruse since most are serials of numbers and letters.  We have Throop/Hastings Mobile Station, DIVVY CASSETTE REPAIR MOBILE STATION, Hubbard Bike-checking (LBS-WH-TEST, DIVVY 001. Start station ids have 770899 blanks and end station ids have 770878 blanks.   Let's start checking these out.

```{r checking locations}
#  pulls Cassette repair, Lyft rack, Throop mobile both starting and ending stations
bikes_2021_v2 %>% 
  filter(start_station_name == "DIVVY CASSETTE REPAIR MOBILE STATION" | start_station_name == "Lyft Driver Center Private Rack" | start_station_name == "Throop/Hastings Mobile Station" | end_station_name == "DIVVY CASSETTE REPAIR MOBILE STATION" | end_station_name == "Lyft Driver Center Private Rack" | end_station_name == "Throop/Hastings Mobile Station")
```

These are the start/end station names with the smallest occurrences.  Together they are 14.  First off, found some of the blanks.  These have a coordinate that is rounded. It seems that a too general latitude or longitude returns no location. Throop/Hastings might be another repair mobile.  Notice how one ends where the next starts in coordinates and time started/ended.  

Lyft Driver Center Private Rack coordinates drop us near the Kennedy Expressway.  They were only taken there for 8 minutes and dropped off at Kingsbury St & Kinzie St.  This is not the closest Divvy station, but according to Google Maps it would take about that long by car and bike.  So that checks out.  I did find a Chicago Lyft Driver Center a few blocks from this location.  This is where Lyft drivers go for repairs.  (Note:  the dataset comes from the Chicago Divvy bike share which is managed by Lyft)  They might come from here actually.  Especially since the coordinates are rounded like some of the blanks.  This data shows two bikes being picked up from untracked locations to the Lyft Driver Center then returned to the Kingsbury and Kinzie location.  

Divvy Cassette Repair Mobile station seems to pick up bikes in areas fix them and then returns them.  The coordinates show the two coordinates for rides ending at Lake Shore Dr are very similar.  Field Museum is just a mile away so not too far. Maybe the rack was full of bikes so they went to the next closest one, just down the way.   

In conclusion, we can get rid of these without effecting the analysis too much.  Also note that the blanks one here all come from the electric bikes.  

``` {r checking locations 2}
# pulls rides at Halseted St and 18th 'duplicates'
bikes_2021_v2 %>% 
  filter(start_station_name == "Halsted St & 18th St (Temp)") %>% 
  arrange(started_at)  #Ran these separately in pairs
bikes_2021_v2 %>% 
  filter(start_station_name == "Halsted St & 18th St") %>% 
  arrange(started_at)
bikes_2021_v2 %>% 
  filter(end_station_name == "Halsted St & 18th St (Temp)") %>% 
  arrange(started_at)
bikes_2021_v2 %>% 
  filter(end_station_name == "Halsted St & 18th St") %>% 
  arrange(started_at)
```

So the temporary Halsted St location is located on 17th St, just around the corner.  It started in July and went to the end of the year, but at this time is no longer active.  They added another location for some reason, but they are valid rides.  Also notice that the blanks here are also electric bikes.

```{r checking locations 3}
# a look at base -2132 hubbard
bikes_2021_v2 %>% 
  filter(start_station_name == "Base - 2132 W Hubbard Warehouse") %>% 
  arrange(started_at)
bikes_2021_v2 %>% 
  filter(end_station_name == "Base - 2132 W Hubbard Warehouse") %>% 
  arrange(started_at)
```

Base - 2132 W Hubbard Warehouse is associated with the station id Hubbard Bike-Checking.  So all rides going to and heading out of Hubbard will be taken out.

```{r checking station ids}
# a look at the possible repair stations from their ids
bikes_2021_v2 %>% 
  filter(start_station_id == "Hubbard Bike-checking (LBS-WH-TEST)" | end_station_id == "Hubbard Bike-checking (LBS-WH-TEST)")
bikes_2021_v2 %>% 
  filter(start_station_id == "DIVVY 001" | end_station_id == "DIVVY 001")
```

These Divvy 001 rides don't lead back to a station.  There is one very close by on Chicago Ave & Kildare Ave.  Also the duration of these rides are appear to be very small.  Let's create a duration row to help with this. First, the start time and end time columns are in character so let's create new rows in numeric to do some subtracting to get our ride duration column.

```{r create posixct times}
#set the start and end times as date time to do some equations later
bikes_2021_v2$time_started <- as_datetime(bikes_2021_v2$started_at)
bikes_2021_v2$time_ended <- as_datetime(bikes_2021_v2$ended_at)
str(bikes_2021_v2)
```

Now we subtract the time ended from the time started to get the result in seconds.

```{r duration and correct format}
# create the duration column
bikes_2021_v2$duration <- difftime(bikes_2021_v2$time_ended, bikes_2021_v2$time_started,) 
str(bikes_2021_v2)
# check the factor
is.factor(bikes_2021_v2$duration)  
bikes_2021_v2$duration <- as.numeric(as.character(bikes_2021_v2$duration))
# check is numeric
is.numeric(bikes_2021_v2$duration)
```

Now we run the Divvy filter again.

```{r checking station ids 2}
# pulling stations with ids Divvy 001 and stations with west chi watson
bikes_2021_v2 %>% 
  filter(start_station_id == "DIVVY 001" | end_station_id == "DIVVY 001"  | start_station_name == "WEST CHI-WATSON" | end_station_name == "WEST CHI-WATSON") %>% 
  arrange(duration)
```

These are not rounded coordinates like the blanks.  All of them do not go to an official bike station and are electric bikes.  Most of them are used for a few seconds.  I haven't made a decision yet on what will be considered a valid ride duration.  I'll have to look at how long are rides that go from one station to the same station.  However because so many go to the same place and are only used for a few seconds, I'm inclined to think that station id DIVVY 001 and station WEST CHI-WATSON are just another repair station or a testing site.  

``` {r double checking}
# pulls starting and ending stations by names
bikes_2021_v2 %>% 
  filter(start_station_name == "DIVVY CASSETTE REPAIR MOBILE STATION" | start_station_name == "Lyft Driver Center Private Rack" | start_station_name == "Throop/Hastings Mobile Station" | start_station_name == "WEST CHI-WATSON" | start_station_name == "Base - 2132 W Hubbard Warehouse") %>% 
  count(start_station_name, start_station_id) %>% 
  arrange(start_station_id)

bikes_2021_v2 %>% 
  filter(end_station_name == "DIVVY CASSETTE REPAIR MOBILE STATION" | end_station_name == "Lyft Driver Center Private Rack" | end_station_name == "Throop/Hastings Mobile Station" | end_station_name == "WEST CHI-WATSON" | end_station_name == "Base - 2132 W Hubbard Warehouse") %>% 
  count(end_station_id, end_station_name) %>% 
  arrange(end_station_id)
```

So the station names are connected to one station.  Now let's double check it works in reverse.

``` {r double checking 2}
# pulls starting and ending stations by id
bikes_2021_v2 %>% 
  filter(start_station_id == "20999" | start_station_id == "DIVVY 001" | start_station_id == "DIVVY CASSETTE REPAIR MOBILE STATION" | start_station_id == "Hubbard Bike-checking (LBS-WH-TEST)" | start_station_id == "Throop/Hastings Mobile Station") %>% 
  count(start_station_name, start_station_id) %>% 
  arrange(start_station_id)

bikes_2021_v2 %>% 
  filter(end_station_id == "20999" | end_station_id == "DIVVY 001" | end_station_id == "DIVVY CASSETTE REPAIR MOBILE STATION" | end_station_id == "Hubbard Bike-checking (LBS-WH-TEST)" | end_station_id == "Throop/Hastings Mobile Station") %>% 
  count(end_station_name, end_station_id) %>% 
  arrange(end_station_id)
```

All right they match up.  Now to double check the others. I want to make sure that stations match up with station IDs.  Then we have to check out those blank station names.

```{r double checking 3}
#pulls any starting and ending station id with their associated station names and how many times it uniquely is connected
bikes_2021_v2 %>% 
  group_by(start_station_id) %>% 
  summarise(no.unique.names = n_distinct(start_station_name), unique_names = str_c(unique(start_station_name), collapse = ",  ")) %>% 
  filter(no.unique.names > 1) 

bikes_2021_v2 %>% 
  group_by(end_station_id) %>% 
  summarise(no.unique.names = n_distinct(end_station_name), unique_names = str_c(unique(end_station_name), collapse = ",  ")) %>% 
  filter(no.unique.names > 1)
```

So we have a start station name by 351 and TA1305000039 refers to 2 stations: Marshfield Ave & Cortland St, Elston Ave & Cortland St and TA1306000029	refers to 3 stations:	Lake Shore Dr & Ohio St, DuSable Lake Shore Dr & Ohio St, McClurg Ct & Ohio St.  A few of them have a DuSable in front of them.  DuSable is a common name in Chicago derived from Jean Baptiste Point du Sable

Most of the duplicates refer to the extra station nearby, but we'll double check these.  

```{r double checking 4}
# pulls station ids 351, TA1306000029, TA1305000039, and then all combined
bikes_2021_v2 %>% 
  filter(start_station_id == "351") %>% 
  arrange(started_at)

bikes_2021_v2 %>% 
  filter(start_station_id == "TA1306000029") %>% 
  arrange(started_at)

bikes_2021_v2 %>% 
  filter(start_station_id == "TA1305000039") %>% 
  arrange(started_at)

bikes_2021_v2 %>% 
  filter(end_station_id == "351" | end_station_id == "TA1305000039" | end_station_id == "TA1306000029") %>% 
  arrange(end_station_id)
```

Anything with start_station_name '351' needs to be renamed 'Mulligan Ave & Wellington Ave'.  It appears to be an error there.  Station ID TA1305000039 refers to Marshfield Ave & Cortland St until late May when Elston Ave & Cortland St takes over for the rest of the year. Then station id TA1305000039 starts at Lake Shore Dr & Ohio St then doesn't move but changes names to DuSable Lake Shore Dr & Ohio St.  From looking at a map, Lake Shore Dr is the name of the street, Dusable Lake Shore Dr is the name of the 'highway' next to it. Also in October, Lake Shore Dr was renamed DuSable Lake shore Dr. Then in December was moved down the street to McClurg Ct.

In summary, the duplicates are because the a street was renamed, added vaccination sites, and stations being moved to different places. 

We do have to change any station with the name 351 to Mulligan Ave & Wellington Ave.
We need to delete the repair stations names and ids: Throop/Hastings Mobile Station, DIVVY CASSETTE REPAIR MOBILE STATION, Hubbard Bike-checking (LBS-WH-TEST), DIVVY 001, Base - 2132 W Hubbard Warehouse, Lyft Driver Center Private Rack, and WEST CHI-WATSON

Now let's delete those rows and then check to see if it worked.

```{r removing rows}
# removing repair or testing entries by starting stations
bikes_2021_v3 <- bikes_2021_v2[!(bikes_2021_v2$start_station_name == "DIVVY CASSETTE REPAIR MOBILE STATION" | bikes_2021_v2$start_station_name == "Lyft Driver Center Private Rack" | bikes_2021_v2$start_station_name == "Throop/Hastings Mobile Station" | bikes_2021_v2$start_station_name == "WEST CHI-WATSON" | bikes_2021_v2$start_station_name == "Base - 2132 W Hubbard Warehouse" | bikes_2021_v2$start_station_id == "Hubbard Bike-checking (LBS-WH-TEST)" | bikes_2021_v2$start_station_name == "DIVVY 001" ),]

# Checking rides are gone
bikes_2021_v3 %>% 
  filter(start_station_name == "DIVVY CASSETTE REPAIR MOBILE STATION" | start_station_name == "Lyft Driver Center Private Rack" | start_station_name == "Throop/Hastings Mobile Station"| start_station_name == "WEST CHI-WATSON" | start_station_name == "Base - 2132 W Hubbard Warehouse" | start_station_id == "Hubbard Bike-checking (LBS-WH-TEST)" | start_station_name == "DIVVY 001" )

# removing repair or testing rides by ending station
bikes_2021_v4 <- bikes_2021_v3[!(bikes_2021_v3$end_station_name == "DIVVY CASSETTE REPAIR MOBILE STATION" | bikes_2021_v3$end_station_name == "Lyft Driver Center Private Rack" | bikes_2021_v3$end_station_name == "Throop/Hastings Mobile Station" | bikes_2021_v3$end_station_name == "WEST CHI-WATSON" | bikes_2021_v3$end_station_name == "Base - 2132 W Hubbard Warehouse" | bikes_2021_v3$end_station_id == "Hubbard Bike-checking (LBS-WH-TEST)" | bikes_2021_v3$end_station_name == "DIVVY 001" ),]

# Checking rides are gone
bikes_2021_v4 %>% 
  filter(end_station_name == "DIVVY CASSETTE REPAIR MOBILE STATION" | end_station_name == "Lyft Driver Center Private Rack" | end_station_name == "Throop/Hastings Mobile Station"| end_station_name == "WEST CHI-WATSON" | end_station_name == "Base - 2132 W Hubbard Warehouse" | end_station_id == "Hubbard Bike-checking (LBS-WH-TEST)" | end_station_name == "DIVVY 001" )
```

Rename station names with '351' to the correct name.  

```{r renaming stations}
# pulls the rides with ids 351
bikes_2021_v4 %>% 
  filter(start_station_id == "351") %>% 
  arrange(start_station_name)
# changes those specific rides with 351 as a station name to the correct name
bikes_2021_v4$start_station_name[bikes_2021_v4$ride_id == "5E181D51F7C391F4"] = "Mulligan Ave & Wellington Ave"
bikes_2021_v4$start_station_name[bikes_2021_v4$ride_id == "3036610505F382EF"] = "Mulligan Ave & Wellington Ave"
# pulls those specific rides again to check
bikes_2021_v4 %>% 
  filter(ride_id == "5E181D51F7C391F4" | ride_id == "3036610505F382EF")
```

Those rides errors have been corrected.
Now to look at those blanks

```{r blanks}
# Can we see them listed here? No
summary(bikes_2021_v4)
# let's look at all the starting station names
bikes_2021_v4 %>% 
  count(start_station_name)
# a look at all the ending station names
bikes_2021_v4 %>% 
  count(end_station_name)
```

We have a negative time as a duration.  We have 690688 blank starting station and 734257 blank ending stations.  I'm guessing we have rides that have both blank starting and ending stations.

```{r blank station}
# pulls all the blank starting names
bikes_2021_v4 %>% 
  filter(start_station_name == "")
```

So just quickly glancing over it looks like the electric bike has some issues with recording the stations. It might be an error I'll have to overlook since removing over 600,000 entries for electric bikes would impact the data for electric bikes.  Also in the description for ebikes indicates that the electric bikes have the ability to be 'locked' in places that are not stations. Locking would signal the end of a ride.  Those rides didn't lock into a station so we have no distinct station recorded. That is valuable information to convey.

``` {r checking blank ending stations}
# pulls the blank ending stations
bikes_2021_v4 %>% 
  filter(end_station_name == "") %>% 
  select(rideable_type, start_station_name, end_station_name, start_lng, end_lng)
```

With the blank ending ones we have the same problem.  It does seem to be the electric bikes.  Unlike the NA's we deleted that had no listed coordinates, these have recorded coordinates and times.  The name of the station is lost somehow.  I am really reluctant to delete these since 800,000 would be a big hit.

We might be able to source possible locations for some, but the coordinates from the correctly recorded rides are very exact.  These are very rounded.  They will apply to many stations. Since ebikes can be locked at private locations, that could describe these issues.  It looks like the bikes are locked and then the ride ends.  Then the user comes back and unlocks the bike and a new ride begins.  It would be interesting to try and connect those rides together but there is no time for that.  

``` {r summary}
# a look at the earliest time each bike type was used.
bikes_2021_v4 %>% 
  group_by(rideable_type) %>% 
  summarise(earliest = min(started_at))
summary(bikes_2021_v4)
```

We still have those a negative duration rides to look at.  I wonder if any have to do with daylight savings.  I've seen some rides go from late at night to early in the morning.  Daylight Savings would impact those riders.  The time data is in Central.  If I change it to a timezone that doesn't recognize Daylight Savings, it wouldn't fix that gap.  I want to try to do it anyway.

``` {r negative durations}
# pulls all duration equal to 1 and under
bikes_2021_v4 %>% 
  filter(duration <= 1) %>% 
  select(ride_id, start_station_name, end_station_name, time_started, time_ended, duration) %>% 
  arrange(time_started)
```

Daylight saving time for 2021 happened on March 14th at 2am.  Time moves forward an hour and skips to 3am.  
Then in November 7th, time was moved back an hour at 2am.  Time moves back to 1am.

Starting with ride id 36CAA82BB5852EF4 at 1:19am in the morning turned in at 1:00am.  The above code only pulled the negative numbers.  If any riders kept it out longer, those rides won't be negative, but the duration of the ride would be affected.   

```{r Nov 7th rides}
# uses the started to create new column for the date, month, day, year, and day of the week for later analysis
bikes_2021_v4$start_date <- as.Date(bikes_2021_v4$started_at)
bikes_2021_v4$month <- format(as.Date(bikes_2021_v4$start_date), "%m")
bikes_2021_v4$day <- format(as.Date(bikes_2021_v4$start_date), "%d")
bikes_2021_v4$year <- format(as.Date(bikes_2021_v4$start_date), "%Y")
bikes_2021_v4$day_of_week <- format(as.Date(bikes_2021_v4$start_date), "%A")
summary(bikes_2021_v4)
```

Now we can pull the specific days.  Let first look at those with the negative ones in November 7th.

```{r pull daylight saving time days}
# pulls the rides occurred on Nov 7 and have a duration under 1 sec
bikes_2021_v4 %>% 
  filter(month == "11" & day == "07" & duration <= 1) %>% 
  select(ride_id, start_station_name, end_station_name, time_started, time_ended, duration) %>% 
  arrange(time_started)
```

There are only 53 rides that were affected by the hour gained.  

For the daylight savings even in March, time moves up by one hour.  It starts at 2am and the clocks should move forward one hour.  
These are going to be harder to see because of the extra added hour.

```{r daylight savings}
# pulls rides that occurred March 14th
bikes_2021_v4 %>% 
  filter(month == "03" & day == "14") %>% 
  select(ride_id, time_started, time_ended, duration) %>% 
  arrange(time_started)
```

So starting at 1:38 am we start to see rides that end at 3am.  I found 32 possible affected rides.

I tried a few different ways to change the time so that the time difference was fixed, but was unable to.  
I tried to add the time in to compensate but that caused Rstudio to shut down so I had to start over.
we are just going to delete them since keeping them isn't an option. 

```{r delete rides with negative durations}
## deletes all rides with durations under 1
bikes_2021_v6 <- bikes_2021_v4[bikes_2021_v4$duration >=1,]
summary(bikes_2021_v6)
```

We can see that those rides are gone but I love double checking.  If done correctly, What should pull up are rides that last 1 second.

```{r doublecheck Nov 7 daylights savings}
# pulls the rides occurred on Nov 7 and have a duration under 1 sec
bikes_2021_v6 %>% 
  filter(month == "11" & day == "07" & duration <= 1) %>% 
  select(ride_id, start_station_name, end_station_name, time_started, time_ended, duration) %>% 
  arrange(time_started)
```

And we did. These next rides are the rides that I believe were affected by daylight savings.  They all have rides that start before 2am and end around 3am.  

```{r daylight savings March 14th }
# pulls rides that occurred March 14th and were affected by daylight savings
bikes_2021_v6 %>% 
  filter(ride_id == "C57E141CF03704D7"| ride_id == "9BAA36FE11793902" | ride_id == "1742E1E1C868296D" | ride_id =="DE67703D329D3423" | ride_id == "B4EB229DD2D99D2F" | ride_id == "86FDC11FA0132DAD" | ride_id == "05A8F6B085B973A1" | ride_id == "FE06D0DF80ABEC33" | ride_id == "425C2C4E189F31EA" | ride_id == "54D1D728E2045497" | ride_id == "98117173186A00B8" | ride_id == "5D70AF81320EA3A3" | ride_id == "D3968BC0BFE21697" | ride_id == "302638FE369B67F5" | ride_id == "DF8C309DFF5ABCD8" | ride_id == "0F66CA964EFCD28E" | ride_id == "A95B83F324E0BDEB" | ride_id == "80E6B4B0EA90AD32" | ride_id == "08B3CF3DF98B758B" | ride_id == "178FD08391670F22" | ride_id == "9C61F08301B87DD1" | ride_id == "7F58E9438E3A782F" | ride_id == "B66A33BE0D820756" | ride_id == "42EFDD3299DD4C70" | ride_id == "35DDEE9348E05D7D" | ride_id == "CCF4998BC32A6E7D" | ride_id == "C66E5A6301F13D84" | ride_id == "F7A7096FDB8E8A39" | ride_id == "FFF6757C245D1899" | ride_id == "9B9060CF745DD7F1" | ride_id == "081549DEA616CA22" | ride_id == "DD5B8BE0217DF562" | ride_id == "663DF74908A97A64") %>% 
  select(ride_id, time_started, time_ended, duration) %>% 
  arrange(time_started)
```

And now to remove those into a new dataframe

```{r Delete}
## Creates a new dataframe/deletes suspected rides with bloated durations
bikes_2021_v7 <- bikes_2021_v6[!(bikes_2021_v6$ride_id == "C57E141CF03704D7"| bikes_2021_v6$ride_id == "9BAA36FE11793902" | bikes_2021_v6$ride_id == "1742E1E1C868296D" | bikes_2021_v6$ride_id =="DE67703D329D3423" | bikes_2021_v6$ride_id == "B4EB229DD2D99D2F" | bikes_2021_v6$ride_id == "86FDC11FA0132DAD" | bikes_2021_v6$ride_id == "05A8F6B085B973A1" | bikes_2021_v6$ride_id == "FE06D0DF80ABEC33" | bikes_2021_v6$ride_id == "425C2C4E189F31EA" | bikes_2021_v6$ride_id == "54D1D728E2045497" | bikes_2021_v6$ride_id == "98117173186A00B8" | bikes_2021_v6$ride_id == "5D70AF81320EA3A3" | bikes_2021_v6$ride_id == "D3968BC0BFE21697" | bikes_2021_v6$ride_id == "302638FE369B67F5" | bikes_2021_v6$ride_id == "DF8C309DFF5ABCD8" | bikes_2021_v6$ride_id == "0F66CA964EFCD28E" | bikes_2021_v6$ride_id == "A95B83F324E0BDEB" | bikes_2021_v6$ride_id == "80E6B4B0EA90AD32" | bikes_2021_v6$ride_id == "08B3CF3DF98B758B" | bikes_2021_v6$ride_id == "178FD08391670F22" | bikes_2021_v6$ride_id == "9C61F08301B87DD1" | bikes_2021_v6$ride_id == "7F58E9438E3A782F" | bikes_2021_v6$ride_id == "B66A33BE0D820756" | bikes_2021_v6$ride_id == "42EFDD3299DD4C70" | bikes_2021_v6$ride_id == "35DDEE9348E05D7D" | bikes_2021_v6$ride_id == "CCF4998BC32A6E7D" | bikes_2021_v6$ride_id == "C66E5A6301F13D84" | bikes_2021_v6$ride_id == "F7A7096FDB8E8A39" | bikes_2021_v6$ride_id == "FFF6757C245D1899" | bikes_2021_v6$ride_id == "9B9060CF745DD7F1" | bikes_2021_v6$ride_id == "081549DEA616CA22" | bikes_2021_v6$ride_id == "DD5B8BE0217DF562" | bikes_2021_v6$ride_id == "663DF74908A97A64" ),]
```

Now we double check our code.

```{r double check}
# pulls the indicated ride by id but they were just deleted so it shouldn't
bikes_2021_v7 %>% 
  filter(ride_id == "C57E141CF03704D7"| ride_id == "9BAA36FE11793902" | ride_id == "1742E1E1C868296D" | ride_id =="DE67703D329D3423" | ride_id == "B4EB229DD2D99D2F" | ride_id == "86FDC11FA0132DAD" | ride_id == "05A8F6B085B973A1" | ride_id == "FE06D0DF80ABEC33" | ride_id == "425C2C4E189F31EA" | ride_id == "54D1D728E2045497" | ride_id == "98117173186A00B8" | ride_id == "5D70AF81320EA3A3" | ride_id == "D3968BC0BFE21697" | ride_id == "302638FE369B67F5" | ride_id == "DF8C309DFF5ABCD8" | ride_id == "0F66CA964EFCD28E" | ride_id == "A95B83F324E0BDEB" | ride_id == "80E6B4B0EA90AD32" | ride_id == "08B3CF3DF98B758B" | ride_id == "178FD08391670F22" | ride_id == "9C61F08301B87DD1" | ride_id == "7F58E9438E3A782F" | ride_id == "B66A33BE0D820756" | ride_id == "42EFDD3299DD4C70" | ride_id == "35DDEE9348E05D7D" | ride_id == "CCF4998BC32A6E7D" | ride_id == "C66E5A6301F13D84" | ride_id == "F7A7096FDB8E8A39" | ride_id == "FFF6757C245D1899" | ride_id == "9B9060CF745DD7F1" | ride_id == "081549DEA616CA22" | ride_id == "DD5B8BE0217DF562" | ride_id == "663DF74908A97A64") %>% 
  select(ride_id, time_started, time_ended, duration) %>% 
  arrange(time_started)
```

That worked well. Now  we need to decided what is considered a legitimate bike ride time.

If you take a bike out and then put it right back and don't ride it anywhere, that shouldn't be considered as a ride.  However a lot of rides only take a few seconds to complete

```{r add time to duration}
# pulls rides that only take under 30 seconds
count(bikes_2021_v7 %>% 
        filter(duration <= 30))
```

Over 55,000 rides are under 30 seconds.  An average bike speed is 15mph so completely possible because that is also 22 feet per second.  We could try to measure

```{r rides under/equal 5 seconds}
#pulls rides under and equal to 5 seconds and stations aren't the same
bikes_2021_v7 %>% 
  filter(duration <= 5 & start_station_name != end_station_name) %>% 
  select(ride_id, start_station_name, end_station_name, time_started, time_ended, duration) %>% 
  arrange(duration)
```

Most of these results are from the ebikes, so we have blank station names.  One ride (DE112B7DF5174363) went from a station on Sheffield Ave & Fullerton Ave to Halsted St and Wrightwood Ave station in 5 seconds.  Those stations are half a mile away from each other in biking distance. A straight distance between the two is .34 miles. If average speed is 15mph, it would take someone around 2 minutes to complete the trip.  If they went straight across, it would take a minute and 22 seconds.  However they completed the distance in 5 seconds.  That means they went 360 miles per hour.  The fastest recorded speed on a flat surface is Denise Mueller-Korenek who went 183 mph. This is a questionable ride.  
Another ride (4344892ED6894278) went from Wabash Ave & Grand Ave to Dearborn St & Erie St in one second.  Google Maps estimates it will take 3 minutes by bike.  


```{r rides over 5 but under 10}
# pulls rides over 5
bikes_2021_v7 %>% 
  filter(duration <= 10 & duration > 5 & start_station_name != end_station_name) %>% 
  select(start_station_name, end_station_name, time_started, time_ended, duration) %>% 
  arrange(duration)
```

The more I look through these, the more I see how many are from the ebikes.  Since ebikes can be locked anywhere to signal the end of a ride, it won't show a starting or ending station.  I don't know why we have rides from ebikes that last a few seconds.  It could be because of user error or a failing battery or it's deliberate.  I don't feel comfortable deleting more rides after my daylight savings deletion.  So we will keep these because they are data that can be used.

```{r final version}
summary(bikes_2021_v7)
str(bikes_2021_v7)
# gets rid of unused columns to trim down the size a bit.  
bikedata <- subset(bikes_2021_v7, select = -c(start_station_id, end_station_id, start_lat, start_lng, end_lat, end_lng, started_at, ended_at, year))
summary(bikedata)
str(bikedata)
```

I removed the station ids columns because those were useful in determining repair stations but the data alone won't help as much as the actually names of the stations.  I removed the longitude and latitudes because we can use the stations to determine distance if needed.  I removed the redundant times columns and the year columns since all the rides occurred in the year 2021.

##Analysis

```{r basic analysis}
mean(bikedata$duration)
median(bikedata$duration)
max(bikedata$duration) 
min(bikedata$duration)

```

The longest ride 3,356,649 seconds, which is about 38.85 days.  

```{r longest ride}
bikedata[bikedata$duration == "3356649",]
```


We can showcase all the mean median, max and min with one line of code
```{r condense to one line}
summary(bikedata$duration)
```

Then we can compare the casual members to the subscribers.

```{r compare members and subscribers}
aggregate(bikedata$duration ~ bikedata$member_casual, FUN = mean)
aggregate(bikedata$duration ~ bikedata$member_casual, FUN = median)
aggregate(bikedata$duration ~ bikedata$member_casual, FUN = max)
```

This is the average ride time by each group by day of the week

```{r average duration by group by day}
aggregate(bikedata$duration ~ bikedata$member_casual + bikedata$day_of_week, FUN = mean)
```

It's our of order and hard to see so let's fix that.
```{r ordered average duration by group by day}
bikedata$day_of_week <- ordered(bikedata$day_of_week, levels = c("Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday"))
```

Now if we run the previous code again. It should be in order.

```{r average duration by group by day 2}
aggregate(bikedata$duration ~ bikedata$member_casual + bikedata$day_of_week, FUN = mean)
```

Let's put this in a bar graph.

```{r viz for average duration by member type and day}
bikedata %>% 
  mutate(day_of_week = wday(time_started, label = TRUE)) %>% 
  group_by(member_casual, day_of_week) %>% 
  summarise(number_of_rides = n()
            ,average_duration = mean(duration)) %>% 
  arrange(member_casual, day_of_week)  %>% 
  ggplot(aes(x = day_of_week, y = average_duration, fill = member_casual)) +
  geom_col(position = "dodge")
```

Let's add some titles to polish this up.  

```{r viz for average duration by member type and day 2}
bikedata %>% 
  group_by(member_casual, day_of_week) %>% 
  summarise(number_of_rides = n()
            ,average_duration = mean(duration/60)) %>% 
  arrange(member_casual, day_of_week)  %>% 
  ggplot(aes(x = day_of_week, y = average_duration, fill = member_casual)) +
  geom_col(position = "dodge") + 
  labs(title = "Average Duration of Rides Daily by Users") +
  labs(fill = "User Type") +
  ylab("Average Duration (minutes)") + 
  xlab("Days of the Week")
```


We can see that casual members use a bike longer than a subscriber member.  They keep it out at least 25 minutes by average to 35.
Members are more consistent at 15 minutes or less.

I want to see which bikes are more popular by membership type.

```{r how many members/casual per bike type}
bikedata %>% 
  group_by(member_casual, rideable_type) %>% 
  summarise(number_of_rides = n()) %>% 
  arrange(member_casual, rideable_type)
```

Let's display the data in a graphic.  Notice how 1 ride was a docked ride for a subscriber member.

```{r viz for how many }
bikedata %>% 
  group_by(member_casual, rideable_type) %>% 
  summarise(number_of_rides = n()) %>% 
  arrange(member_casual, rideable_type)  %>% 
  ggplot(aes(x = rideable_type, y = number_of_rides, fill = member_casual)) +
  geom_col(position = "dodge") + 
  labs(title = "Number of Rides by Bike Type and Membership Type") + 
  labs(fill = "Membership Type") +
  ylab("Number of Rides") + 
  xlab("Bike Type")
```

Let's see if average duration in minutes by day and bike type.

```{r average duration by day and bike type}
bikedata %>% 
  group_by(rideable_type, day_of_week) %>% 
  summarise(number_of_rides = n()
            ,average_duration = mean(duration/60)) %>% #in minutes
  arrange(rideable_type, day_of_week)
```

```{r average duration by day and bike type viz}
bikedata %>% 
  group_by(rideable_type, day_of_week) %>% 
  summarise(number_of_rides = n()
            ,average_duration = mean(duration/60)) %>% #in minutes
  arrange(rideable_type, day_of_week)  %>% 
  ggplot(aes(x = day_of_week, y = average_duration, fill = rideable_type)) +
  geom_col(position = "dodge") + 
  labs(title = "Average Ride Duration by Day and Bike Type") + 
  ylab("Average Duration (minutes)") + 
  xlab("Day of Week")
```

How interesting that docked bikes are kept out so much longer, but account for few rides.



```{r number of rides by day and rider type viz}
bikedata %>% 
  group_by(member_casual, day_of_week) %>% 
  summarise(number_of_rides = n()) %>% 
  arrange(member_casual, day_of_week)

bikedata %>% 
  group_by(member_casual, day_of_week) %>% 
  summarise(number_of_rides = n()) %>% 
  arrange(member_casual, day_of_week)  %>% 
  ggplot(aes(x = day_of_week, y = number_of_rides, fill = member_casual)) +
  geom_col(position = "dodge") + 
  labs(title = "Number of Rides by Day and Rider Type") + 
  ylab("Number of Rides") + 
  xlab("Day of Week")
```

So casual riders keep the bikes out longer around 20 to 35 minutes by average, but make less rides.
Members keep the bikes for shorter rides around 15 minutes by average, but take more rides.

```{r number of rides by mont and rider type}
bikedata %>% 
  group_by(member_casual, month) %>% 
  summarise(number_of_rides = n()) %>% 
  arrange(member_casual, month) 


bikedata %>% 
  group_by(member_casual, month) %>% 
  summarise(number_of_rides = n()) %>% 
  arrange(member_casual, month)  %>% 
  ggplot(aes(x = month, y = number_of_rides, group = member_casual)) +
  geom_line(aes(color = member_casual)) + 
  geom_point() +
  labs(title = "Number of Rides by Month and Rider Type") + 
  ylab("Number of Rides") + 
  xlab("Months")
```

































